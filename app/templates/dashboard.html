{% extends "base.html" %}

{% block title %}Dashboard - LMS Analytics{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2>Discussion Analytics Dashboard</h2>
        <p class="text-muted">Welcome to the LMS Discussion Analytics Platform</p>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4>{{ courses|length }}</4>
                        <p class="mb-0">Total Courses</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-graduation-cap fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4>{{ recent_entries|length }}</h4>
                        <p class="mb-0">Recent Posts</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-comments fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 id="active-users">-</h4>
                        <p class="mb-0">Active Users</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-users fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h4 id="engagement-rate">-</h4>
                        <p class="mb-0">Engagement Rate</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-chart-line fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5>Course Overview</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Course</th>
                                <th>Semester</th>
                                <th>Code</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for course in courses %}
                            <tr>
                                <td>{{ course.course_name }}</td>
                                <td>{{ course.semester }}</td>
                                <td>{{ course.course_code }}</td>
                                <td>
                                    <a href="/analytics/{{ course.course_id }}" class="btn btn-sm btn-primary">
                                        <i class="fas fa-chart-bar"></i> Analytics
                                    </a>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5>Recent Activity</h5>
            </div>
            <div class="card-body">
                <div style="max-height: 400px; overflow-y: auto;">
                    {% for entry in recent_entries %}
                    <div class="border-bottom pb-2 mb-2">
                        <small class="text-muted">{{ entry.entry_created_at.strftime('%Y-%m-%d %H:%M') }}</small>
                        <p class="mb-1">{{ entry.topic.topic_title }}</p>
                        <small>by {{ entry.author.user_name }} in {{ entry.topic.course.course_name }}</small>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5>Discussion Activity Timeline</h5>
            </div>
            <div class="card-body">
                <div id="timeline-chart" style="height: 300px;"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Load dashboard analytics
async function loadDashboardData() {
    try {
        const response = await fetch('/api/analytics/course-stats');
        const data = await response.json();
        
        // Update stats cards
        if (data.participation_stats) {
            const totalUsers = data.participation_stats.reduce((sum, stat) => sum + stat.active_students, 0);
            document.getElementById('active-users').textContent = totalUsers;
        }
        
        // Load timeline chart
        const timelineResponse = await fetch('/api/analytics/discussion-timeline');
        const timelineData = await timelineResponse.json();
        
        const trace = {
            x: timelineData.map(d => d.date),
            y: timelineData.map(d => d.posts),
            type: 'scatter',
            mode: 'lines+markers',
            name: 'Posts',
            line: {color: '#007bff'}
        };
        
        const layout = {
            title: '',
            xaxis: {title: 'Date'},
            yaxis: {title: 'Number of Posts'},
            margin: {t: 30}
        };
        
        Plotly.newPlot('timeline-chart', [trace], layout);
        
    } catch (error) {
        console.error('Error loading dashboard data:', error);
    }
}

// Load data when page loads
document.addEventListener('DOMContentLoaded', loadDashboardData);
</script>
{% endblock %}
